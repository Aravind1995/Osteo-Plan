<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<title>OsteoPlan v1.0</title>
<link rel="icon" href="icon.png">
<link href="styles.css" rel="stylesheet"/>
</head>
<body>
<div class="app">
<header class="topbar">
<div class="brand"><img src="icon.png" alt="OsteoPlan" style="height:22px;width:22px;object-fit:contain;border-radius:4px;margin-right:8px;">
<span>OsteoPlan v1.0</span></div>
<div class="actions">
<label class="file-btn">
<input accept="image/*,.jpg,.jpeg,.png,.bmp,.gif,.webp" id="imageLoader" type="file"/>
<span class="ico">ğŸ“</span> Load Image
        </label>
<label class="chk"><input checked="" id="exportReadouts" type="checkbox"/> Export readouts</label>
<button class="ghost" id="btnExport"><span class="ico">ğŸ–¼ï¸</span> Export PNG</button>
<button class="ghost" id="btnSaveJSON"><span class="ico">ğŸ’¾</span> Save</button>

<div class="divider"></div>
<button class="ghost" id="btnHelp">â” Help</button>

    <button id="portraitPresets" class="corner-btn" title="Presets (mobile)">â˜°</button>
    <button id="portraitActions" class="corner-btn right" title="Actions (mobile)">âš™</button>
</div>
</header>
<div class="content">
<aside class="sidebar">
<div class="panel">
<div class="panel-title">Tools</div>
<div class="toolgrid">
<button class="tool active" data-tool="pan" title="Pan/Select (V)">Pan</button>
<button class="tool" data-tool="line" title="Line (L)">Line</button>
<button class="tool" data-tool="angle3" title="Angle (A)">Angle</button>
<button class="tool" data-tool="calibrate" title="Calibrate (C)">Cal</button>
<button id="btnUndo" title="Undo (Z)">Undo</button>
<button id="btnReset" title="Reset (keep image)">Reset</button>
</div>
</div>
<div class="panel">
<div class="panel-title">Presets</div>
<select id="presetSelect"><option value="">â€” choose â€”</option><optgroup label="Alignment"><option value="HKA">HKA</option><option value="TibialSlope">Tibial Slope</option><option value="MPTA">MPTA</option><option value="LDFA">LDFA</option><option value="JLCA">JLCA</option><option value="HTO">HTO (Miniaci)</option></optgroup><optgroup label="ACL"><option value="ACL_TT">ACL â€“ Tibial Tunnel Angle (Lat)</option><option value="ACL_TT_AP">ACL â€“ Tibial Tunnel Inclination (AP)</option><option value="ACL_TT_PCT">ACL â€“ Tibial Tunnel % (AP)</option><option value="ACL_TT_ML">ACL â€“ Tibial Tunnel % (ML)</option><option value="ACL_BH">ACL â€“ Femoral Tunnel (Bernardâ€“Hertel)</option><option value="ACL_LEN">ACL â€“ Screw Length</option><option value="ACL_CLOCK">ACL â€“ Femoral Clockâ€‘face</option></optgroup></select>
<div class="hint">HTO: wedge size in mm (after calibration) and shaded wedge.</div>
</div>
<div class="panel" style="display:none">
<div class="panel-title">Presets â€” ACL Postâ€‘op</div>
<select id="presetACL">
<option value="">â€” choose â€”</option>
<option value="ACL_TT">ACL â€“ Tibial Tunnel Angle (Lat)</option>
<option value="ACL_TT_AP">ACL â€“ Tibial Tunnel Inclination (AP)</option>
<option value="ACL_TT_PCT">ACL â€“ Tibial Tunnel % (AP)</option>
<option value="ACL_TT_ML">ACL â€“ Tibial Tunnel % (ML)</option>

<option value="ACL_BH">ACL â€“ Femoral Tunnel (Bernardâ€“Hertel)</option>

<option value="ACL_LEN">ACL â€“ Screw Length</option>
<option value="ACL_CLOCK">ACL â€“ Femoral Clockâ€‘face</option>
</select>
<div class="rows">
<label>Knee side (for Clockâ€‘face)</label>
<select id="kneeSide">
<option selected="" value="right">Right</option>
<option value="left">Left</option>
</select>
</div>
</div>
<div class="panel">
<div class="panel-title">Calibration</div>
<div class="rows">
<label>Known length</label>
<div class="inline">
<input id="calLen" step="0.1" type="number" value="100"/>
<select id="calUnits"><option value="mm">mm</option><option value="cm">cm</option></select>
</div>
<div class="tiny">Select Cal tool, click two points on the marker, set value.</div>
<div class="ok" id="calStatus"></div>
</div>
</div>
<div class="panel" style="display:none">
<div class="panel-title">Reference (editable)</div>
<div class="rows tinyform">
<label>HKA (Â°): <input id="refHKAlo" step="0.5" type="number" value="1"/>â€“<input id="refHKAhi" step="0.5" type="number" value="3"/></label>
<label>MPTA (Â°): <input id="refMPTAlo" step="0.5" type="number" value="85"/>â€“<input id="refMPTAhi" step="0.5" type="number" value="90"/></label>
<label>LDFA (Â°): <input id="refLDFAlo" step="0.5" type="number" value="85"/>â€“<input id="refLDFAhi" step="0.5" type="number" value="90"/></label>
<label>Tibial slope (Â°): <input id="refSlopeLo" step="0.5" type="number" value="5"/>â€“<input id="refSlopeHi" step="0.5" type="number" value="10"/></label>
<label>JLCA (Â°): <input id="refJLCAlo" step="0.5" type="number" value="0"/>â€“<input id="refJLCAhi" step="0.5" type="number" value="3"/></label>
<label>BH deepâ€“shallow (%): <input id="refBHxlo" step="0.5" type="number" value="22"/>â€“<input id="refBHxhi" step="0.5" type="number" value="28"/></label>
<label>BH highâ€“low (%): <input id="refBHylo" step="0.5" type="number" value="28"/>â€“<input id="refBHyhi" step="0.5" type="number" value="35"/></label>
<label>TT angle Lat (Â°): <input id="refTTLatLo" step="0.5" type="number" value="50"/>â€“<input id="refTTLatHi" step="0.5" type="number" value="65"/></label>
<label>TT incl AP (Â°): <input id="refTTAPLo" step="0.5" type="number" value="60"/>â€“<input id="refTTAPHi" step="0.5" type="number" value="70"/></label>
<label>TT % AP: <input id="refTTPctLo" step="0.5" type="number" value="40"/>â€“<input id="refTTPctHi" step="0.5" type="number" value="45"/></label>
<label>TT % ML: <input id="refTTMLLo" step="0.5" type="number" value="48"/>â€“<input id="refTTMLHi" step="0.5" type="number" value="55"/></label>
<label>TT vs Plateau (Â°): <input id="refTTSagLo" step="0.5" type="number" value="50"/>â€“<input id="refTTSagHi" step="0.5" type="number" value="70"/></label>
<label>Divergence (Â° â‰¤): <input id="refDIVMax" step="0.5" type="number" value="15"/></label>
<label>Clock-face target: <select id="refClockRight"><option>10 o'clock</option><option selected="">10:30</option><option>11</option></select> â€¢ <select id="refClockLeft"><option>1</option><option selected="">1:30</option><option>2</option></select></label>
<button class="ghost" id="refSave">Save refs</button>
</div>
<div class="hint">Edit to your preference; values go âœ” if inside range.</div>
</div>
<div class="panel">
<div class="panel-title">Case notes (exported)</div>
<textarea id="caseNotes" placeholder="Patient / Case ID, limb side, postop day, commentsâ€¦" rows="6"></textarea>
<div class="tiny">Printed in the right info strip if "Export readouts" is enabled.</div>
</div>
</aside>
<section class="stage">
<div id="canvasWrapper">
<canvas id="canvas"></canvas>
<div id="overlayInfo"></div>
<div class="slim-hint" id="dropHint">Tap the canvas to choose an image â€¢ or drag &amp; drop</div>
<div class="guided" id="guided"></div>
<div class="badge" id="wedgeBadge"></div>
</div>
</section>
<aside class="inspector">
<div class="panel">
<div class="panel-title">Results</div>
<div class="readouts-actions">
<button class="ghost small" id="selAll">Select all</button>
<button class="ghost small" id="selNone">Clear</button>
</div>
<div class="readouts" id="readouts"></div>
</div>
</aside>
</div>
</div>
<div class="help" id="helpModal">
<div class="help-box">
<div class="help-head">
<h3>Help</h3>
<button class="ghost" id="helpClose">âœ•</button>
</div>
<div class="help-body">
<p>Guided presets: HKA, MPTA, LDFA, JLCA, HTO; ACL: TT (Lat/AP), TT % (AP/ML), TT vs Plateau (Sagittal), Bernardâ€“Hertel, Divergence, Screw length, Clockâ€‘face.</p>
<p>Use Line, Angle, Cal tools for generic measures. Calibrate to get mm.</p>
<p>Readouts panel stores each measurement with a checkbox; checked items are exported.</p>
</div>
</div>
</div>
<div id="toast"></div>
<script src="app.js"></script>

<script>
/* Responsive helper: make canvas fit mobile portrait/landscape and provide two corner buttons behaviour.
   This tries to be non-intrusive: it won't replace existing app logic, just helps layout and resizing. */
(function(){
  const topbar = document.querySelector('.topbar');
  const sidebar = document.querySelector('.sidebar');
  const inspector = document.querySelector('.inspector');
  const canvas = document.getElementById('canvas');
  const canvasWrapper = document.getElementById('canvasWrapper');
  const presetBtn = document.getElementById('portraitPresets');
  const actionBtn = document.getElementById('portraitActions');

  function applyMobileLayout(){
    const isMobile = window.matchMedia('(max-width:900px), (orientation: portrait)').matches;
    if(isMobile){
      document.body.classList.add('mobile-compact');
      // hide sidebars visually but keep them accessible as overlays
      if(sidebar) sidebar.style.display = 'none';
      if(inspector) inspector.style.display = 'none';
      // make canvas wrapper full height under topbar
      const topH = topbar ? topbar.getBoundingClientRect().height : 54;
      canvasWrapper.style.height = `calc(100vh - ${topH}px)`;
      // show portrait buttons
      if(presetBtn) presetBtn.style.display = 'inline-flex';
      if(actionBtn) actionBtn.style.display = 'inline-flex';
    } else {
      document.body.classList.remove('mobile-compact');
      if(sidebar) sidebar.style.display = '';
      if(inspector) inspector.style.display = '';
      canvasWrapper.style.height = '';
      if(presetBtn) presetBtn.style.display = 'none';
      if(actionBtn) actionBtn.style.display = 'none';
    }
    resizeCanvasForHiDPI();
    // announce resize so existing app.js can react if it listens
    window.dispatchEvent(new Event('app-resize'));
  }

  function resizeCanvasForHiDPI(){
    if(!canvas) return;
    const ratio = window.devicePixelRatio || 1;
    const w = Math.max(300, Math.floor(canvas.clientWidth * ratio));
    const h = Math.max(200, Math.floor(canvas.clientHeight * ratio));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext && canvas.getContext('2d');
      if(ctx && typeof ctx.setTransform === 'function'){
        ctx.setTransform(ratio,0,0,ratio,0,0);
      }
      // some apps attach a global redraw function; trigger if exists
      if(typeof window.appRedraw === 'function') window.appRedraw();
    }
  }

  // Toggle overlay panels (clone content into a floating sheet) for mobile buttons
  function showOverlayPanel(sourcePanel){
    if(!sourcePanel) return;
    // create overlay
    const overlay = document.createElement('div');
    overlay.className = 'mobile-overlay';
    overlay.innerHTML = '<div class="mobile-overlay-inner"></div><button class="mobile-overlay-close">âœ•</button>';
    document.body.appendChild(overlay);
    const inner = overlay.querySelector('.mobile-overlay-inner');
    // clone content (shallow) and append
    const clone = sourcePanel.cloneNode(true);
    clone.style.display = 'block';
    clone.classList.add('mobile-clone');
    inner.appendChild(clone);
    overlay.querySelector('.mobile-overlay-close').addEventListener('click', ()=> overlay.remove());
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) overlay.remove(); });
  }

  if(presetBtn){
    presetBtn.addEventListener('click', ()=>{
      // prefer the Presets panel if present
      const part = document.querySelector('.panel .panel-title:contains("Presets")');
      // fallback to sidebar
      showOverlayPanel(document.querySelector('.sidebar') || document.querySelector('.panel'));
    });
  }
  if(actionBtn){
    actionBtn.addEventListener('click', ()=> showOverlayPanel(document.querySelector('.inspector') || document.querySelector('.sidebar')));
  }

  // windows that don't support :contains querySelector - add helper fallback for presets search
  document.querySelectorAll('.panel .panel-title').forEach(function(el){
    if(/presets/i.test(el.textContent)){
      el.closest('.panel').id = 'mobilePresetsPanel';
    }
  });
  if(presetBtn){
    presetBtn.addEventListener('click', ()=>{
      const p = document.getElementById('mobilePresetsPanel');
      if(p) return showOverlayPanel(p);
    });
  }

  // Expose a small API for app.js if it wants to call
  window.OsteoPlanResponsive = {
    resize: resizeCanvasForHiDPI,
    apply: applyMobileLayout
  };

  // Apply on load + resize + orientationchange
  window.addEventListener('resize', applyMobileLayout);
  window.addEventListener('orientationchange', applyMobileLayout);
  window.addEventListener('load', applyMobileLayout);
  // initial call
  applyMobileLayout();
})();
</script>

</body>
</html>
